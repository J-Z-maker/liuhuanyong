本篇文章针对的是中科院软件所刘焕勇老师在github上的开源项目，基于知识图谱的医药领域问答项目QABasedOnMedicalKnowledgeGraph。



该项目是一个以疾病为中心的医疗领域知识图谱，并基于此实现一个自动问答系统，是典型的KBQA系统流程，包括知识图谱构建和问答系统两大部分。知识图谱构建——从数据爬取到图谱存储的全流程，数据来源于寻医问药网（data\_spider.py)，使用Neo4j图数据库存储，图谱包括约3.7万实体，21万关系。问答系统实现讲的是基于规则和分类模型理解问题并返回答案，使用朴素贝叶斯分类器来进行意图识别，AC自动机和相似度匹配进行实体识别（注意这两个识别方法没有权重比，而是依次执行），对于答案查询，则解析为Cypher查询语句。



原项目地址：https://github.com/liuhuanyong/QASystemOnMedicalKG



挂载加速器后进入github，来到https://github.com/liuhuanyong/QASystemOnMedicalKG这个地方，可以直接将整个项目的压缩包下载到自己的电脑里。

![github页面]([github.png](https://github.com/J-Z-maker/liuhuanyong/blob/main/images/github.png?raw=true))

![下载页面](download.png)

(当然，也可以选择下载github DeskTop，并用其直接打开该项目)



整个项目的运行思路：

（一）prepare_data/data_spider.py -> 爬取原始数据

（二）prepare_data/max_cut.py -> 在数据准备阶段用于对爬取到的文本进行分词，以便于后续的结构化提取

（三）prepare_data/build_data.py -> 利用分词后的数据和其他处理，构建结构化的知识图谱数据（medical.json）

（四）data/：——存放医疗数据文件（medical.json）。

（五）dict/：存放各类实体词典（如疾病、症状、药品等）。

（六）build_medicalgraph.py——知识图谱构建的主入口（读取数据，创建节点和关系，并将其导入Neo4j数据库）

（七）chatbot_graph.py——问答系统的主入口。问答系统又包含了三个核心处理模块，依次是

 	1）question_classifier.py——问题分类器（对用户的问题进行意图识别，判断问题类型，基于规则和特征词进行问题分类）

 	2）question_parser.py——问题解析器（通过Cypher查询将问题意图与知识图谱结果对应，即根据分类器的结果，将自然语言问题解析成一系列预先设计好的Cypher查询模板）

 	3）answer_search.py——答案搜索（接收解析后的Cypher查询，执行查询，并从返回的图数据库结果中构建和格式化最终答案）。



按照上述的执行顺序依次运行相应的python文件，我这边儿使用的是pycharm社区版，在运行过程中会遇到一些环境配置相关的问题，下面会给出我在实际运行过程中所遇到的相关问题。

(注意：刘焕勇老师这个项目中，data/medical.json这个文件是经过上面的前三个运行步骤之后的结果。)



正常来说，在运行每个python文件时，遇到缺少的库，可以直接在终端里使用‘pip install ……’指令安装。当遇到需要管理员权限才能安装的库时，可以通过管理员权限打开cmd，打开之后在里边儿通过pip指令安装。

![管理权限pip](pip.png)

![cmd](cmd入口.png)

除此之外，需要注意的问题会在下方给出详细的说明。



一、data_spider.py

运行data_spider.py前，需要满足：1）安装 MongoDB 软件；2）启动 MongoDB 服务；3）安装 pymongo 驱动库（pip install pymongo）



步骤 1：下载 MongoDB



打开官方下载地址：https://www.mongodb.com/try/download/community



版本选择（默认即可，无需修改）：

（1）Version：选择最新的稳定版（比如7.0.x，带LTS标识的是长期支持版，更稳定）；

（2）OS：选择Windows；

（3）Package：选择msi（图形化安装包，适合初学者）；

点击Download，等待安装包下载完成。



步骤 2：安装 MongoDB



双击下载的 .msi 安装包，弹出安装向导，点击「Next」；

勾选「I accept the terms in the License Agreement」（同意协议），点击「Next」；



选择安装类型：

推荐「Complete」（完整安装，默认路径：C:\Program Files\MongoDB\Server\版本号\bin）；

若想自定义路径（比如 D:\MongoDB），选择「Custom」，手动修改路径后点击「Next」；



关键设置（必须勾选！）：

勾选「Run MongoDB as a service」（将 MongoDB 作为系统服务，开机自动启动，无需手动启动）；

下方选择「Automatic」（自动启动），点击「Next」；

配置数据存储目录（默认即可，无需修改）：

Data Directory（数据存储目录）：默认 C:\ProgramData\MongoDB\data\db；

Log Directory（日志目录）：默认 C:\ProgramData\MongoDB\log；

点击「Next」，再点击「Install」，等待安装完成（约 1-2 分钟）；

安装完成后，取消勾选「Install MongoDB Compass」（可视化工具，体积大，初学者暂时用不到），点击「Finish」。



步骤 3：验证安装是否成功

按下 Win + R，输入 services.msc，打开「服务」面板；

找到「MongoDB」服务，查看「状态」是否为「正在运行」（若未运行，右键点击「启动」）；

打开命令提示符（CMD），输入以下命令：

mongo --version  # 查看 MongoDB 版本

mongo            # 连接本地 MongoDB 服务

若出现类似以下内容，说明安装成功：

版本提示：MongoDB shell version v7.0.x；

连接成功：MongoDB server version: 7.0.x（进入 > 命令行交互界面，输入 exit 可退出）。



！注意！：

如果按上述的步骤安装时，勾选了这两个选项（默认就是勾选的）：

Run MongoDB as a service（将 MongoDB 作为系统服务）

Automatic（自动启动）

那么 MongoDB 会在电脑开机后自动启动，后台一直运行，完全不用管它，直接运行爬虫脚本即可，脚本会自动连接到 MongoDB 服务。



如何确认自己是这种情况？

按下 Win + R，输入 services.msc，打开「服务」面板；

找到「MongoDB」服务，查看两个关键信息：

「启动类型」：显示「自动」；

「状态」：显示「正在运行」

（电脑开机后会自动变成这个状态）。

只要是这样，就不用每次手动输命令，直接运行爬虫就行。



特殊情况（需要手动启动）

如果安装时没勾选「Run MongoDB as a service」，或者把「启动类型」改成了「手动」，那么 MongoDB 不会自动启动，此时需要手动启动服务，否则爬虫会报错 “连接失败”。



手动启动的两种简单方法（选一种即可）：



（1）命令行启动（最快）：

按下 Win + R，输入 cmd，打开命令提示符（CMD）；

直接输入命令（不用管理员权限，普通用户即可）：

net start mongodb

看到提示「MongoDB 服务已经启动成功」，就说明启动好了，之后再运行爬虫。

（2）服务面板启动：

按下 Win + R，输入 services.msc，打开「服务」面板；

找到「MongoDB」服务，右键点击 → 选择「启动」；

看到「状态」变成「正在运行」，就可以运行爬虫了。



手动启动后，关闭服务的方法：

如果不想让 MongoDB 一直后台运行，爬虫跑完后可以关闭服务：

命令行输入：net stop mongodb；

或服务面板右键「MongoDB」→「停止」。





二、build_medicalgraph.py

在build_medicalgraph.py中，会使用到neo4j。在这个问题上，我们有两种选择。

选择一：

从官网下载Neo4j Desktop,但是它不面向中国地区下载，一般的加速器也难以下载成功，如果有需求的话，这边儿推荐使用ghelper。

操作步骤如下：

（1）创建数据库：

打开 Neo4j Desktop，点击左侧「Projects」→ 「New Project」（新建项目，比如命名为「MedicalGraph」）；

在项目中点击「Add Database」→ 「Create a Local Database」；

（2）填写数据库信息：

Database Name：任意；

Password：任意；

其他默认（版本选 4.x/5.x 都可，推荐 4.x 更稳定）；

点击「Create」，等待数据库创建完成。

（3）启动数据库：

数据库创建后，点击右侧「Start」启动服务；

启动成功后，会显示「Running」。



验证是否连接：

点击数据库右侧「Open」，打开 Neo4j Browser（网页端）；

输入用户名、密码，登录成功说明数据库配置正常。



（4）安装依赖库（py2neo）

代码中用 py2neo 库操作 Neo4j，需要手动安装：

打开命令行（Windows CMD/macOS Terminal/ Linux Terminal）；

输入以下命令安装（推荐指定版本，避免兼容性问题）：

pip install py2neo==2021.2.3

安装成功提示：Successfully installed py2neo-2021.2.3 ...



选择二：

先安装neo4j社区版并完成相关配置,再手动配置java环境。



1)Neo4j



1. 下载并解压Neo4j安装包

1.1 下载

通过网盘分享的文件：neo4j-community-5.26.0-windows.zip

链接: https://pan.baidu.com/s/154B6-yGwv9PXnevZYXAopQ 提取码: deex

1.2 解压

把下载好的Neo4j安装包neo4j-chs-community-4.2.3-windows.zip解压到C:\neo4j目录中。



2. 配置环境变量

2.1 打开系统属性设置

右键点击“此电脑”，选择“属性”，点击“高级系统设置”。

在弹出的“系统属性”窗口中，点击“环境变量”。

![环境变量]（environment.png）

2.2 编辑 PATH 环境变量

在“环境变量”窗口中，找到“系统变量”部分，然后点击“新建”，然后输入变量名和解压的Neo4j安装路径，然后点击确定

变量名：NEO4J_HOME

变量值：C:\neo4j\neo4j-community-5.26.0-windows\neo4j-community-5.26.0

![neo4j_home](neo4j_home.png)

上面我把安装文件解压到了C盘neo4j文件里，变量值就填写C盘中neo4j的文件路径，你把安装文件解压到哪个磁盘就填写对应磁盘的安装文件路径。

然后找到系统变量里面的【Path】变量，选中之后点击【编辑】

![path编辑](path.png)

再点击【新建】,然后输入环境变量%NEO4J_HOME%\bin

![path新建](new_build.png)



上面步骤变量确认输入无误后，点击【确定】，点击“确定”保存更改，然后连续点击每个窗口上的“确定”按钮以关闭所有设置窗口并保存更改。



之后，必须要配置Java路径，否则在终端启动neo4j时，会出现下图所示的报错。

![neo4j报错](error.png)



2）Java

1.安装并配置 Java

安装Java（Neo4j5.26.0 需要Java17）：

下载Java 17：

访问https://www.oracle.com/java/technologies/downloads/#java17 

选择Windows x64安装程序

安装Java：

运行下载的安装程序

按照默认设置安装即可



2\.配置 Java 环境变量

在“环境变量”窗口中，找到“系统变量”部分，然后点击“新建”，然后输入变量名和解压的java安装路径，然后点击确定

变量名：JAVA_HOME

变量值：C:\neo4j\java

![java_home](java_home.png)

上面我把安装文件解压到了C盘neo4j文件里，变量值就填写C盘中neo4j的文件路径，你把安装文件解压到哪个磁盘就填写对应磁盘的安装文件路径。

然后找到系统变量里面的【Path】变量，选中之后点击【编辑】

![path编辑](path.png)

再点击【新建】,然后输入环境变量%JAVA_HOME%\bin

![path新建](new2_build.png)



上面步骤变量确认输入无误后，点击【确定】，点击“确定”保存更改，然后连续点击每个窗口上的“确定”按钮以关闭所有设置窗口并保存更改。



3.验证 Java 安装

重新打开命令提示符，测试 Java：



java -version

javac -version

echo %JAVA_HOME%


应该显示 Java 17 的版本信息。



3）重新启动Neo4j（在终端中输入下面两行代码）



# 切换到 Neo4j 的 bin 目录

cd C:\neo4j\neo4j-community-5.26.0-windows\neo4j-community-5.26.0\bin



# 启动 Neo4j

neo4j.bat console



随后打开浏览器，访问：http://localhost:7474跳转到neo4j网页（注意终端输入完那两行代码后不要关闭终端）

![neo4j网页](neo4j_web.png)

将初始默认的账号和密码都改成自己的，随后将build_medicalgraph.py和answer_search.py中调用neo4j的部分，分别改成下面的样式，注意端口号和账号、密码均要改成自己的。

![build_medicalgraph](build_medicalgraph.png)、

![answer_search](answer_search.png)

至此，build_medicalgraph.py运行完毕。（注意：该文件仅运行过一次就行，后续再使用该项目只需要运行问答系统即可）

三、chatbot_graph.py

运行到chatbot_graph.py时，会依次调用question_classifier.py、question_parser.py、answer_search.py，但是在运行question_classifier.py时，会遇到缺失ahocorasick这个库的情况，这个时候在pycharm里的终端和有管理员权限的cmd使用pip install ahocorasick均会安装失败。

这是因为原库名 ahocorasick 已停用，现需使用 pyahocorasick 进行安装和调用 。

安装方法

打开具有管理员权限的cmd使用pip指令安装：

pip install pyahocorasick

！注意！：代码中导入时仍使用 `ahocorasick` 模块名，实际调用的是改名后的新库。



至此，刘焕勇老师在github上的医药知识图谱项目从部署配环境到整个项目跑起来遇到的全部细节已讲解完毕。





